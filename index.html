<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü™ê</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.5.0/css/flag-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script type="module">
        import { animate, stagger } from "https://cdn.jsdelivr.net/npm/motion@10/dist/motion.es.js";
        window.motion = { animate, stagger };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000011;
            overflow: hidden;
            cursor: crosshair;
            font-family: Arial, sans-serif;
        }

        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            color: #00ffff;
            font-size: 2rem;
            text-shadow: 0 0 10px #00ffff;
            user-select: none;
        }

        .country-info {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            color: #ffffff;
            text-align: center;
            font-size: 1.2rem;
            text-shadow: 0 0 10px #000000;
        }

        .leaderboard {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0, 0, 17, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 0 12px 12px;
            border-top: none;
            width: 400px;
            overflow: hidden;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .leaderboard.collapsed {
            height: auto;
        }

        .leaderboard.collapsed .leaderboard-content,
        .leaderboard.collapsed .leaderboard-header {
            max-height: 0;
            padding: 0;
            overflow: hidden;
        }

        .leaderboard-toggle {
            position: relative;
            margin: 8px auto;
            background: rgba(0, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #000;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .leaderboard-toggle:hover {
            background: rgba(0, 255, 255, 1);
            transform: scale(1.1);
        }

        .leaderboard-header {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard h3 {
            color: #ffffff;
            text-align: center;
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .leaderboard-preview {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-preview-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .leaderboard-preview-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-country {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #ffd700;
        }

        .leaderboard-header {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05));
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .leaderboard-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px 0;
            transition: all 0.3s ease;
        }

        .leaderboard-content::-webkit-scrollbar {
            width: 6px;
        }

        .leaderboard-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .leaderboard-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .leaderboard-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .leaderboard-row.user-country {
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
        }

        .leaderboard-row.user-country:hover {
            background: rgba(0, 255, 255, 0.15);
        }

        .leaderboard-cell {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .rank-cell {
            width: 50px;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: #ffffff;
        }

        .rank-cell.gold { color: #ffd700; }
        .rank-cell.silver { color: #c0c0c0; }
        .rank-cell.bronze { color: #cd7f32; }

        .country-cell {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .country-flag {
            width: 24px;
            height: 18px;
            border-radius: 3px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .country-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .score-cell {
            text-align: right;
            font-weight: 600;
            color: #00ffff;
            white-space: nowrap;
            width: 80px;
        }

        .loading-state {
            padding: 40px 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .mute-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .mute-btn:hover {
            opacity: 1;
        }

        .emoji-explosion {
            position: fixed;
            font-size: 3rem;
            pointer-events: none;
            z-index: 999;
        }

        .social-links {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 15px;
        }

        .social-links a {
            font-size: 2rem;
            text-decoration: none;
            opacity: 0.7;
            transition: all 0.3s;
        }

        .social-links a:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .loading {
            color: #888;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .hud {
                font-size: 1.5rem;
            }
            .leaderboard {
                width: 250px;
                right: 10px;
                top: 10px;
            }
            .country-info {
                top: 10px;
                font-size: 1rem;
            }
            .social-links {
                bottom: 10px;
                left: 10px;
            }
            .social-links a {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <div id="scene-container"></div>
    
    <div class="hud">
        <div id="fart-counter">üí® 0</div>
    </div>
    
    <div class="country-info">
        <div id="user-location">üåç Detecting location...</div>
    </div>
    
    <div class="leaderboard collapsed" id="leaderboard">
        <div class="leaderboard-preview">
            <div class="leaderboard-preview-left">
                <span>#1 Leading:</span>
            </div>
            <div class="leaderboard-preview-right">
                <div class="top-country" id="top-country-preview">
                    <span class="loading-state">Loading...</span>
                </div>
            </div>
        </div>
        <div class="leaderboard-header">
            <h3>üí® Global Fartboard</h3>
        </div>
        <div class="leaderboard-content">
            <div id="leaderboard-table-container">
                <div class="loading-state">Loading countries...</div>
            </div>
        </div>
        <button class="leaderboard-toggle" id="leaderboardToggle">‚ñº</button>
    </div>
    
    <button class="mute-btn" id="muteBtn">üîä</button>
    
    <div class="social-links">
        <a href="https://twitter.com/intent/tweet?text=I%20just%20made%20Uranus%20fart%20in%203D!%20üöÄüí®&url=https://enteruranus.com" target="_blank">üê¶</a>
        <a href="https://t.me/share/url?url=https://enteruranus.com&text=I%20just%20made%20Uranus%20fart%20in%203D!%20üöÄüí®" target="_blank">‚úàÔ∏è</a>
    </div>

    <script>
        class UranusUniverse {
            constructor() {
                this.fartCount = 0;
                this.isMuted = false;
                this.audioContext = null;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.uranusPlanet = null;
                this.flyingObjects = [];
                this.particles = [];
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.isInsideUranus = false;
                this.cameraTarget = new THREE.Vector3(0, 0, 0);
                
                // Global leaderboard properties
                this.userCountry = null;
                this.userCountryCode = null;
                this.database = null;
                this.leaderboardData = {};
                
                // Initialize country mapping FIRST
                this.countryNames = this.initCountryData();
                console.log('Country names initialized:', this.countryNames);
                
                this.init();
            }

            initCountryData() {
                // Country code to name and flag mapping
                return {
                    'US': { name: 'United States', flag: 'üá∫üá∏' },
                    'CN': { name: 'China', flag: 'üá®üá≥' },
                    'TH': { name: 'Thailand', flag: 'üáπüá≠' },
                    'HK': { name: 'Hong Kong', flag: 'üá≠üá∞' },
                    'TW': { name: 'Taiwan', flag: 'üáπüáº' },
                    'JP': { name: 'Japan', flag: 'üáØüáµ' },
                    'KR': { name: 'South Korea', flag: 'üá∞üá∑' },
                    'MY': { name: 'Malaysia', flag: 'üá≤üáæ' },
                    'SA': { name: 'Saudi Arabia', flag: 'üá∏üá¶' },
                    'ID': { name: 'Indonesia', flag: 'üáÆüá©' },
                    'FI': { name: 'Finland', flag: 'üá´üáÆ' },
                    'SE': { name: 'Sweden', flag: 'üá∏üá™' },
                    'GB': { name: 'United Kingdom', flag: 'üá¨üáß' },
                    'DE': { name: 'Germany', flag: 'üá©üá™' },
                    'FR': { name: 'France', flag: 'üá´üá∑' },
                    'IT': { name: 'Italy', flag: 'üáÆüáπ' },
                    'ES': { name: 'Spain', flag: 'üá™üá∏' },
                    'BR': { name: 'Brazil', flag: 'üáßüá∑' },
                    'CA': { name: 'Canada', flag: 'üá®üá¶' },
                    'AU': { name: 'Australia', flag: 'üá¶üá∫' },
                    'IN': { name: 'India', flag: 'üáÆüá≥' },
                    'RU': { name: 'Russia', flag: 'üá∑üá∫' },
                    'MX': { name: 'Mexico', flag: 'üá≤üáΩ' },
                    'AR': { name: 'Argentina', flag: 'üá¶üá∑' },
                    'PL': { name: 'Poland', flag: 'üáµüá±' },
                    'NL': { name: 'Netherlands', flag: 'üá≥üá±' },
                    'BE': { name: 'Belgium', flag: 'üáßüá™' },
                    'CH': { name: 'Switzerland', flag: 'üá®üá≠' },
                    'AT': { name: 'Austria', flag: 'üá¶üáπ' },
                    'NO': { name: 'Norway', flag: 'üá≥üá¥' },
                    'DK': { name: 'Denmark', flag: 'üá©üá∞' }
                };
            }

            async init() {
                this.setupAudio();
                this.createScene();
                this.createUranus();
                this.createStarfield();
                this.createFlyingObjects();
                this.setupEventListeners();
                this.loadProgress();
                this.animate();
                
                // Initialize global leaderboard system
                await this.initFirebase();
                await this.detectUserLocation();
                this.setupLeaderboardListener();
                
                // Spawn flying objects periodically
                setInterval(() => this.spawnFlyingObject(), 2000);
            }

            async initFirebase() {
                try {
                    // Firebase configuration (using a demo project - replace with your own)
                    const firebaseConfig = {
                        apiKey: "demo-key",
                        authDomain: "uranus-fart-leaderboard.firebaseapp.com",
                        databaseURL: "https://uranus-fart-leaderboard-default-rtdb.firebaseio.com/",
                        projectId: "uranus-fart-leaderboard"
                    };

                    // For demo purposes, we'll use localStorage as a fallback
                    console.log('Firebase would be initialized here with real config');
                    this.initLocalStorageLeaderboard();
                } catch (error) {
                    console.log('Firebase not available, using localStorage fallback');
                    this.initLocalStorageLeaderboard();
                }
            }

            initLocalStorageLeaderboard() {
                // Initialize with demo data for development
                const demoData = {
                    'TH': 45000000,
                    'HK': 32000000,
                    'TW': 28000000,
                    'JP': 25000000,
                    'KR': 18000000,
                    'MY': 15000000,
                    'SA': 12000000,
                    'US': 9500000,
                    'ID': 8200000,
                    'FI': 6800000,
                    'SE': 5900000
                };
                
                // Force clear any old cached data
                localStorage.removeItem('globalLeaderboard');
                localStorage.setItem('globalLeaderboard', JSON.stringify(demoData));
                this.leaderboardData = demoData;
                
                // Debug: Verify country mapping is working
                console.log('=== DEBUGGING LEADERBOARD ===');
                console.log('Demo data:', this.leaderboardData);
                console.log('Country names mapping:', this.countryNames);
                
                // Test mapping for TH
                console.log('TH maps to:', this.countryNames['TH']);
            }

            async detectUserLocation() {
                try {
                    // Try multiple IP geolocation services
                    const services = [
                        'https://ipapi.co/json/',
                        'https://ip-api.com/json/',
                        'https://ipinfo.io/json'
                    ];

                    for (const service of services) {
                        try {
                            const response = await fetch(service);
                            const data = await response.json();
                            
                            if (data.country_code || data.countryCode || data.country) {
                                this.userCountryCode = data.country_code || data.countryCode || data.country;
                                this.userCountry = this.countryNames[this.userCountryCode]?.name || this.userCountryCode;
                                
                                const userFlagIcon = `<span class="fi fi-${this.userCountryCode.toLowerCase()}" 
                                                           style="width: 20px; height: 15px; display: inline-block; margin-right: 8px; border-radius: 2px;" 
                                                           title="Flag of ${this.userCountry}"></span>`;
                                document.getElementById('user-location').innerHTML = `${userFlagIcon}${this.userCountry}`;
                                
                                console.log(`Detected location: ${this.userCountry} (${this.userCountryCode})`);
                                break;
                            }
                        } catch (err) {
                            console.log(`Service ${service} failed:`, err);
                        }
                    }
                    
                    if (!this.userCountryCode) {
                        // Fallback to US for demo
                        this.userCountryCode = 'US';
                        this.userCountry = 'United States';
                        const fallbackFlag = `<span class="fi fi-us" 
                                                   style="width: 20px; height: 15px; display: inline-block; margin-right: 8px; border-radius: 2px;" 
                                                   title="Flag of United States"></span>`;
                        document.getElementById('user-location').innerHTML = `${fallbackFlag}United States (Demo)`;
                    }
                    
                } catch (error) {
                    console.log('Location detection failed:', error);
                    this.userCountryCode = 'US';
                    this.userCountry = 'United States';
                    document.getElementById('user-location').innerHTML = `<span style="margin-right: 8px;">üåç</span>Location Unknown`;
                }
            }

            setupLeaderboardListener() {
                // Update leaderboard every 5 seconds
                this.updateLeaderboard();
                setInterval(() => {
                    this.updateLeaderboard();
                }, 5000);
            }

            updateLeaderboard() {
                const tableContainer = document.getElementById('leaderboard-table-container');
                const topCountryPreview = document.getElementById('top-country-preview');
                
                // Sort countries by fart count
                const sortedCountries = Object.entries(this.leaderboardData)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10); // Top 10

                if (sortedCountries.length === 0) {
                    tableContainer.innerHTML = '<div class="loading-state">Loading countries...</div>';
                    topCountryPreview.innerHTML = '<span class="loading-state">Loading...</span>';
                    return;
                }

                // Update top country preview
                if (sortedCountries.length > 0) {
                    const [topCountryCode, topCount] = sortedCountries[0];
                    const topCountryInfo = this.countryNames[topCountryCode];
                    const topDisplayName = topCountryInfo?.name || 'Unknown';
                    const topFlagIcon = `<span class="fi fi-${topCountryCode.toLowerCase()}" 
                                              style="width: 18px; height: 14px; border-radius: 2px;" 
                                              title="Flag of ${topDisplayName}"></span>`;
                    
                    topCountryPreview.innerHTML = `
                        ${topFlagIcon}
                        <span>${topDisplayName}</span>
                        <span style="color: #00ffff;">üí® ${this.formatNumberFull(topCount)}</span>
                    `;
                }

                let html = '<table class="leaderboard-table">';
                
                sortedCountries.forEach(([countryCode, count], index) => {
                    const countryInfo = this.countryNames[countryCode];
                    const isUserCountry = countryCode === this.userCountryCode;
                    const rank = index + 1;
                    
                    let rankClass = 'rank-cell';
                    let rankDisplay = rank;
                    
                    if (rank === 1) {
                        rankClass += ' gold';
                        rankDisplay = 'ü•á';
                    } else if (rank === 2) {
                        rankClass += ' silver';
                        rankDisplay = 'ü•à';
                    } else if (rank === 3) {
                        rankClass += ' bronze';
                        rankDisplay = 'ü•â';
                    }
                    
                    // Ensure we show flag + country name, never country codes
                    const displayName = countryInfo?.name || 'Unknown';
                    
                    // Create flag icon using flag-icons library
                    const flagIcon = `<span class="fi fi-${countryCode.toLowerCase()} country-flag" 
                                           title="Flag of ${displayName}" 
                                           aria-label="Flag of ${displayName}"></span>`;
                    
                    html += `
                        <tr class="leaderboard-row ${isUserCountry ? 'user-country' : ''}">
                            <td class="${rankClass}">${rankDisplay}</td>
                            <td class="leaderboard-cell">
                                <div class="country-cell">
                                    ${flagIcon}
                                    <span class="country-name">${displayName}</span>
                                </div>
                            </td>
                            <td class="leaderboard-cell score-cell">üí® ${this.formatNumberFull(count)}</td>
                        </tr>
                    `;
                });

                html += '</table>';
                tableContainer.innerHTML = html;
            }

            formatNumber(num) {
                if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
                if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
                if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
                return num.toString();
            }

            formatNumberFull(num) {
                // Format with commas for full numbers
                return num.toLocaleString();
            }

            incrementGlobalCount() {
                if (this.userCountryCode) {
                    // Add to country's count
                    this.leaderboardData[this.userCountryCode] = 
                        (this.leaderboardData[this.userCountryCode] || 0) + 1;
                    
                    // Save to localStorage (in real app, this would sync to Firebase)
                    localStorage.setItem('globalLeaderboard', JSON.stringify(this.leaderboardData));
                    
                    // Update leaderboard display
                    this.updateLeaderboard();
                    
                    console.log(`Added fart for ${this.userCountry}: ${this.leaderboardData[this.userCountryCode]}`);
                }
            }

            setupAudio() {
                if ('AudioContext' in window || 'webkitAudioContext' in window) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Load the real fart sound
                this.fartAudio = new Audio('sound_effects/PROUD_FART.mp3');
                this.fartAudio.preload = 'auto';
            }

            createUranus() {
                // Create a 2D plane for sprite animation instead of 3D sphere
                const geometry = new THREE.PlaneGeometry(10, 10);
                
                // Create high-resolution canvas for sprite animation with transparency
                this.spriteCanvas = document.createElement('canvas');
                this.spriteCanvas.width = 1024;
                this.spriteCanvas.height = 1024;
                this.spriteCtx = this.spriteCanvas.getContext('2d');
                
                // Enable high-quality image rendering
                this.spriteCtx.imageSmoothingEnabled = true;
                this.spriteCtx.imageSmoothingQuality = 'high';
                
                // Enable transparency
                this.spriteCtx.globalCompositeOperation = 'source-over';
                
                // Animation properties for your 4 frames
                this.currentFrame = 0;
                this.totalFrames = 4;
                this.isAnimating = false;
                this.animationSpeed = 100; // 100ms per frame = 400ms total (50% faster)
                
                // Load your custom image sequence
                this.loadCustomImageSequence();
                
                // Create texture from canvas with transparency
                this.spriteTexture = new THREE.CanvasTexture(this.spriteCanvas);
                this.spriteTexture.needsUpdate = true;
                // Remove flipY to keep original orientation
                
                const material = new THREE.MeshBasicMaterial({ 
                    map: this.spriteTexture,
                    transparent: true,
                    alphaTest: 0.1,
                    side: THREE.DoubleSide
                });
                
                this.uranusPlanet = new THREE.Mesh(geometry, material);
                this.uranusPlanet.userData = { type: 'uranus' };
                this.uranusPlanet.position.set(0, 0, 0);
                this.scene.add(this.uranusPlanet);
                
                console.log('Created static Uranus plane with transparency');
            }
            
            // Load your custom 4-frame sequence
            loadCustomImageSequence() {
                const imagePaths = [
                    'Assets/First.png',     // Frame 0 - Normal planet (capital F)
                    'Assets/second.png',    // Frame 1 - Animation frame 1 (lowercase)
                    'Assets/third.png',     // Frame 2 - Animation frame 2 (lowercase)
                    'Assets/fourth.png'     // Frame 3 - Animation frame 3 (lowercase)
                ];
                
                console.log('Loading planet image sequence:', imagePaths);
                
                this.imageSequence = [];
                this.totalFrames = imagePaths.length;
                this.currentFrame = 0;
                this.isAnimating = false;
                this.imagesLoaded = 0;
                
                // Load all images with better error handling
                imagePaths.forEach((path, index) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        console.log(`‚úì Loaded planet image ${index + 1}/${imagePaths.length}: ${path} (${img.naturalWidth}x${img.naturalHeight})`);
                        this.imagesLoaded++;
                        
                        if (this.imagesLoaded === imagePaths.length) {
                            console.log('üéâ All planet images loaded! Showing First.png...');
                            console.log('Image sequence status:', this.imageSequence.map((img, i) => `Frame ${i}: ${img.complete ? '‚úÖ' : '‚ùå'} ${img.naturalWidth}x${img.naturalHeight}`));
                            // Show the first frame (normal planet)
                            setTimeout(() => this.drawImageFrame(0), 100);
                        }
                    };
                    
                    img.onerror = (error) => {
                        console.error(`‚ùå Failed to load planet image: ${path}`, error);
                        // Try to continue with other images
                        this.imagesLoaded++;
                    };
                    
                    this.imageSequence[index] = img;
                    img.src = path;
                });
            }
            
            // Draw frame from image sequence with proper transparency
            drawImageFrame(frameIndex) {
                if (!this.imageSequence || !this.imageSequence[frameIndex]) {
                    console.error(`‚ùå Planet image not ready: frameIndex=${frameIndex}`);
                    return;
                }
                
                const img = this.imageSequence[frameIndex];
                if (!img.complete || img.naturalWidth === 0) {
                    console.error(`‚ùå Planet image not fully loaded: frameIndex=${frameIndex}, complete=${img.complete}, naturalWidth=${img.naturalWidth}`);
                    return;
                }
                
                // Clear canvas completely with transparency
                this.spriteCtx.clearRect(0, 0, this.spriteCanvas.width, this.spriteCanvas.height);
                
                // Save context state
                this.spriteCtx.save();
                
                try {
                    // Draw the planet image centered with proper transparency
                    this.spriteCtx.globalCompositeOperation = 'source-over';
                    this.spriteCtx.drawImage(
                        img,
                        0, 0, img.naturalWidth, img.naturalHeight, // Source
                        0, 0, this.spriteCanvas.width, this.spriteCanvas.height // Destination
                    );
                    
                    console.log(`‚úÖ Successfully drew planet frame: ${frameIndex} (${img.src.split('/').pop()}) - ${img.naturalWidth}x${img.naturalHeight}`);
                } catch (error) {
                    console.error(`‚ùå Error drawing frame ${frameIndex}:`, error);
                }
                
                // Restore context state
                this.spriteCtx.restore();
                
                // Force texture update
                this.spriteTexture.needsUpdate = true;
            }
            
            // Play the click animation: First.png ‚Üí second.png ‚Üí third.png ‚Üí fourth.png ‚Üí First.png
            playClickAnimation() {
                if (this.isAnimating) {
                    console.log('üö´ Animation already in progress, skipping');
                    return; // Don't interrupt current animation
                }
                
                if (this.imagesLoaded < 4) {
                    console.log('üö´ Images not fully loaded yet, skipping animation');
                    return;
                }
                
                console.log('üé¨ Starting planet click animation...');
                console.log('Current animation state:', {
                    isAnimating: this.isAnimating,
                    imagesLoaded: this.imagesLoaded,
                    totalFrames: this.totalFrames,
                    imageSequenceLength: this.imageSequence?.length
                });
                this.isAnimating = true;
                
                // Animation sequence: 1 ‚Üí 2 ‚Üí 3 ‚Üí back to 0 (1 second total)
                const sequence = [1, 2, 3, 0];
                let sequenceIndex = 0;
                
                const animateFrame = () => {
                    if (sequenceIndex < sequence.length) {
                        const frameIndex = sequence[sequenceIndex];
                        console.log(`üéûÔ∏è Animating to frame ${frameIndex} (${this.imageSequence[frameIndex]?.src})`);
                        this.drawImageFrame(frameIndex);
                        sequenceIndex++;
                        
                        // Continue animation after delay
                        setTimeout(animateFrame, this.animationSpeed);
                    } else {
                        // Animation complete
                        this.isAnimating = false;
                        console.log('‚úÖ Planet click animation complete - back to frame 0');
                    }
                };
                
                // Start the animation immediately
                animateFrame();
            }

            createScene() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
                this.camera.position.set(0, 0, 10);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x000011, 1);
                document.getElementById('scene-container').appendChild(this.renderer.domElement);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(5, 5, 5);
                this.scene.add(directionalLight);
            }

            createStarfield() {
                const starGeometry = new THREE.BufferGeometry();
                const starVertices = [];
                const starColors = [];
                
                for (let i = 0; i < 10000; i++) {
                    const x = (Math.random() - 0.5) * 2000;
                    const y = (Math.random() - 0.5) * 2000;
                    const z = (Math.random() - 0.5) * 2000;
                    starVertices.push(x, y, z);
                    
                    // Random star colors
                    const color = new THREE.Color();
                    color.setHSL(Math.random(), 0.5, Math.random() * 0.5 + 0.5);
                    starColors.push(color.r, color.g, color.b);
                }
                
                starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(starColors, 3));
                
                const starMaterial = new THREE.PointsMaterial({
                    size: 2,
                    vertexColors: true,
                    transparent: true
                });
                
                const stars = new THREE.Points(starGeometry, starMaterial);
                this.scene.add(stars);
            }

            createFlyingObjects() {
                // Pre-create some flying objects
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => this.spawnFlyingObject(), i * 1000);
                }
            }

            spawnFlyingObject() {
                const types = ['rocket', 'ufo', 'asteroid', 'satellite'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                let geometry, material, mesh;
                
                switch (type) {
                    case 'rocket':
                        geometry = new THREE.ConeGeometry(0.2, 1, 8);
                        material = new THREE.MeshPhongMaterial({ color: 0xff4444 });
                        mesh = new THREE.Mesh(geometry, material);
                        break;
                    case 'ufo':
                        geometry = new THREE.SphereGeometry(0.5, 16, 8);
                        geometry.scale(1, 0.3, 1);
                        material = new THREE.MeshPhongMaterial({ color: 0x44ff44 });
                        mesh = new THREE.Mesh(geometry, material);
                        break;
                    case 'asteroid':
                        geometry = new THREE.DodecahedronGeometry(0.5);
                        material = new THREE.MeshPhongMaterial({ color: 0x888888 });
                        mesh = new THREE.Mesh(geometry, material);
                        break;
                    case 'satellite':
                        geometry = new THREE.BoxGeometry(0.3, 0.3, 0.8);
                        material = new THREE.MeshPhongMaterial({ color: 0xcccccc });
                        mesh = new THREE.Mesh(geometry, material);
                        break;
                }
                
                // Random starting position
                mesh.position.set(
                    (Math.random() - 0.5) * 40,
                    (Math.random() - 0.5) * 40,
                    -50
                );
                
                mesh.userData = { 
                    type: type,
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.1,
                        (Math.random() - 0.5) * 0.1,
                        Math.random() * 0.2 + 0.1
                    ),
                    rotation: new THREE.Vector3(
                        Math.random() * 0.02,
                        Math.random() * 0.02,
                        Math.random() * 0.02
                    )
                };
                
                this.scene.add(mesh);
                this.flyingObjects.push(mesh);
                
                // Remove after it's far away
                setTimeout(() => {
                    this.scene.remove(mesh);
                    const index = this.flyingObjects.indexOf(mesh);
                    if (index > -1) {
                        this.flyingObjects.splice(index, 1);
                    }
                }, 30000);
            }

            createFartParticles(position) {
                const particleCount = 50;
                const geometry = new THREE.BufferGeometry();
                const positions = [];
                const velocities = [];
                
                for (let i = 0; i < particleCount; i++) {
                    // Start near the planet
                    positions.push(
                        position.x + (Math.random() - 0.5) * 2,
                        position.y + (Math.random() - 0.5) * 2,
                        position.z + (Math.random() - 0.5) * 2
                    );
                    
                    // Random velocities
                    velocities.push(
                        (Math.random() - 0.5) * 0.2,
                        (Math.random() - 0.5) * 0.2,
                        (Math.random() - 0.5) * 0.2
                    );
                }
                
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                
                const material = new THREE.PointsMaterial({
                    color: 0x88ff88,
                    size: 0.1,
                    transparent: true,
                    opacity: 0.8
                });
                
                const particles = new THREE.Points(geometry, material);
                particles.userData = { 
                    velocities: velocities,
                    life: 2.0
                };
                
                this.scene.add(particles);
                this.particles.push(particles);
            }

            updateParticles() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    const positions = particle.geometry.attributes.position.array;
                    const velocities = particle.userData.velocities;
                    
                    for (let j = 0; j < positions.length; j += 3) {
                        positions[j] += velocities[j];
                        positions[j + 1] += velocities[j + 1];
                        positions[j + 2] += velocities[j + 2];
                    }
                    
                    particle.geometry.attributes.position.needsUpdate = true;
                    particle.userData.life -= 0.016;
                    particle.material.opacity = particle.userData.life / 2.0;
                    
                    if (particle.userData.life <= 0) {
                        this.scene.remove(particle);
                        this.particles.splice(i, 1);
                    }
                }
            }

            setupEventListeners() {
                window.addEventListener('resize', () => this.onWindowResize());
                window.addEventListener('click', (event) => this.onMouseClick(event));
                window.addEventListener('mousemove', (event) => this.onMouseMove(event));
                
                document.getElementById('muteBtn').addEventListener('click', () => this.toggleMute());
                document.getElementById('leaderboardToggle').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleLeaderboard();
                });
            }

            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            onMouseMove(event) {
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            }

            onMouseClick(event) {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObjects(this.scene.children, true);
                
                if (intersects.length > 0) {
                    const clickedObject = intersects[0].object;
                    
                    if (clickedObject.userData.type === 'uranus' || clickedObject.parent?.userData.type === 'uranus') {
                        this.touchUranus(intersects[0].point);
                    } else {
                        // Clicked on flying object
                        this.explodeObject(clickedObject, intersects[0].point);
                    }
                }
            }

            playFartSound() {
                if (this.isMuted) return;
                
                try {
                    // Play the real fart sound
                    if (this.fartAudio) {
                        this.fartAudio.currentTime = 0; // Reset to beginning
                        this.fartAudio.play().catch(error => {
                            console.log('Audio play failed:', error);
                            // Fallback to synthetic sound
                            this.playSyntheticFartSound();
                        });
                    } else {
                        // Fallback to synthetic sound
                        this.playSyntheticFartSound();
                    }
                } catch (error) {
                    console.log('Audio playback failed:', error);
                    this.playSyntheticFartSound();
                }
            }
            
            playSyntheticFartSound() {
                if (this.isMuted || !this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(80, this.audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(40, this.audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                
                oscillator.type = 'sawtooth';
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 0.3);
            }

            touchUranus(point) {
                this.fartCount++;
                this.updateCounter();
                this.saveProgress();
                
                // Add to global leaderboard
                this.incrementGlobalCount();
                
                // Only sound and animation - no particles or shake
                this.playFartSound();
                this.playClickAnimation();
                
                // Check for special events
                this.checkEasterEggs();
            }

            explodeObject(object, point) {
                // Remove the object
                this.scene.remove(object);
                const index = this.flyingObjects.indexOf(object);
                if (index > -1) {
                    this.flyingObjects.splice(index, 1);
                }
                
                // Create explosion particles
                this.createExplosion(point);
                this.playExplosionSound();
                
                // Show emoji explosion
                this.showEmojiExplosion(['üí•', '‚≠ê', '‚ú®', 'üî•'][Math.floor(Math.random() * 4)]);
            }

            createExplosion(position) {
                const particleCount = 30;
                const geometry = new THREE.BufferGeometry();
                const positions = [];
                const velocities = [];
                
                for (let i = 0; i < particleCount; i++) {
                    positions.push(position.x, position.y, position.z);
                    
                    const velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 0.5,
                        (Math.random() - 0.5) * 0.5,
                        (Math.random() - 0.5) * 0.5
                    );
                    velocities.push(velocity.x, velocity.y, velocity.z);
                }
                
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                
                const material = new THREE.PointsMaterial({
                    color: 0xff8800,
                    size: 0.2,
                    transparent: true
                });
                
                const explosion = new THREE.Points(geometry, material);
                explosion.userData = { 
                    velocities: velocities,
                    life: 1.0
                };
                
                this.scene.add(explosion);
                this.particles.push(explosion);
            }

            shakeCamera() {
                // Simple camera shake without Motion One
                const originalPosition = this.camera.position.clone();
                const shakeIntensity = 0.2;
                const shakeDuration = 300; // ms
                const shakeSteps = 10;
                const stepDuration = shakeDuration / shakeSteps;
                
                let step = 0;
                const shakeInterval = setInterval(() => {
                    if (step < shakeSteps) {
                        // Random shake
                        this.camera.position.x = originalPosition.x + (Math.random() - 0.5) * shakeIntensity;
                        this.camera.position.y = originalPosition.y + (Math.random() - 0.5) * shakeIntensity * 0.5;
                        step++;
                    } else {
                        // Return to original position
                        this.camera.position.copy(originalPosition);
                        clearInterval(shakeInterval);
                    }
                }, stepDuration);
            }

            showEmojiExplosion(emoji) {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const emojiEl = document.createElement('div');
                        emojiEl.className = 'emoji-explosion';
                        emojiEl.textContent = emoji;
                        emojiEl.style.left = Math.random() * window.innerWidth + 'px';
                        emojiEl.style.top = Math.random() * window.innerHeight + 'px';
                        document.body.appendChild(emojiEl);
                        
                        if (window.motion && window.motion.animate) {
                            window.motion.animate(emojiEl, 
                                { 
                                    scale: [0, 2, 0],
                                    rotate: [0, 360],
                                    opacity: [0, 1, 0]
                                },
                                { duration: 1.5, ease: "ease-out" }
                            ).finished.then(() => {
                                emojiEl.remove();
                            });
                        } else {
                            // Fallback without motion library
                            setTimeout(() => emojiEl.remove(), 1500);
                        }
                    }, i * 100);
                }
            }

            checkEasterEggs() {
                if (this.fartCount === 69) {
                    this.showEmojiExplosion('üçë');
                    this.playSpecialSound();
                } else if (this.fartCount === 100) {
                    this.enterUranusMode();
                } else if (this.fartCount === 420) {
                    this.showEmojiExplosion('üåø');
                    this.createRainbowEffect();
                }
            }

            enterUranusMode() {
                if (this.isInsideUranus) return;
                
                this.isInsideUranus = true;
                this.showEmojiExplosion('üöÄ');
                
                // Zoom camera into planet
                if (window.motion && window.motion.animate) {
                    window.motion.animate(this.camera.position, 
                        { z: 0.5 },
                        { duration: 3, ease: "ease-in-out" }
                    ).finished.then(() => {
                        // Show inside Uranus for a moment
                        setTimeout(() => {
                            window.motion.animate(this.camera.position, 
                                { z: 10 },
                                { duration: 2, ease: "ease-out" }
                            ).finished.then(() => {
                                this.isInsideUranus = false;
                            });
                        }, 2000);
                    });
                } else {
                    // Fallback without motion library
                    console.log('Motion library not available for Uranus mode');
                    this.camera.position.z = 0.5;
                    setTimeout(() => {
                        this.camera.position.z = 10;
                        this.isInsideUranus = false;
                    }, 5000);
                }
            }

            createRainbowEffect() {
                // Change the planet colors temporarily
                const originalColor = this.uranusPlanet.material.color.clone();
                const colors = [0xff0000, 0xff8800, 0xffff00, 0x00ff00, 0x0088ff, 0x4400ff, 0x8800ff];
                
                let colorIndex = 0;
                const interval = setInterval(() => {
                    this.uranusPlanet.material.color.setHex(colors[colorIndex]);
                    colorIndex = (colorIndex + 1) % colors.length;
                }, 200);
                
                setTimeout(() => {
                    clearInterval(interval);
                    this.uranusPlanet.material.color.copy(originalColor);
                }, 3000);
            }

            playExplosionSound() {
                if (this.isMuted || !this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, this.audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, this.audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                
                oscillator.type = 'square';
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 0.2);
            }

            playSpecialSound() {
                if (this.isMuted || !this.audioContext) return;
                
                // Play a sequence of tones
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(200 + i * 100, this.audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                        
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.2);
                    }, i * 150);
                }
            }

            updateCounter() {
                document.getElementById('fart-counter').textContent = `üí® ${this.fartCount}`;
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                document.getElementById('muteBtn').textContent = this.isMuted ? 'üîá' : 'üîä';
            }

            toggleLeaderboard() {
                const leaderboard = document.getElementById('leaderboard');
                const toggleBtn = document.getElementById('leaderboardToggle');
                const isCollapsed = leaderboard.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expand - show full leaderboard
                    leaderboard.classList.remove('collapsed');
                    toggleBtn.textContent = '‚ñ≤';
                } else {
                    // Collapse - show only preview
                    leaderboard.classList.add('collapsed');
                    toggleBtn.textContent = '‚ñº';
                }
            }

            saveProgress() {
                localStorage.setItem('uranusProgress', JSON.stringify({
                    farts: this.fartCount
                }));
            }

            loadProgress() {
                const saved = localStorage.getItem('uranusProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.fartCount = data.farts || 0;
                    this.updateCounter();
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Update flying objects
                for (const obj of this.flyingObjects) {
                    obj.position.add(obj.userData.velocity);
                    obj.rotation.x += obj.userData.rotation.x;
                    obj.rotation.y += obj.userData.rotation.y;
                    obj.rotation.z += obj.userData.rotation.z;
                }
                
                // Update particles
                this.updateParticles();
                
                this.renderer.render(this.scene, this.camera);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new UranusUniverse();
        });

        // Enable audio on first click
        document.addEventListener('click', function enableAudio() {
            if (window.AudioContext || window.webkitAudioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }
            document.removeEventListener('click', enableAudio);
        }, { once: true });
    </script>
</body>
</html>